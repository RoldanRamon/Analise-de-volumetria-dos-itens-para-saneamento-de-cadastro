SELECT DISTINCT A.DATAINCLUSAO AS DATA_INCLUSAO,
F.NOME AS NOME_EMPRESA,
G.NOME AS NOME_FILIAL,
A.NUMERO AS ORDEM_COMPRA,
CASE WHEN H.MODALIDADE = 'R' THEN 'REGULARIZAÇÃO' ELSE
    CASE WHEN H.MODALIDADE = 'C' THEN 'CATALOGO' ELSE 'NORMAL' END
END AS MODALIDADE,
D.QUANTIDADE AS QUANTIDADE_COMPRADA,
D.TOTALGERAL AS GASTO,
AC.CODIGO AS CODIGO_ITEM

FROM CP_ORDENSCOMPRA A

LEFT JOIN     (SELECT DISTINCT NUMERO,MODALIDADE,SOLICITANTE FROM CP_SOLICITACOES) H ON H.NUMERO = A.NUMERODOCUMENTOORIGEM  AND A.ORIGEM IN (1,13)
INNER JOIN  CP_ORDENSCOMPRAITENS D ON A.HANDLE = D.ORDEMCOMPRA
LEFT JOIN EMPRESAS F ON F.HANDLE = A.EMPRESA
LEFT JOIN FILIAIS G ON G.HANDLE = A.FILIAL
LEFT JOIN FN_CONTAS I ON I.HANDLE = D.CONTAFINANCEIRA
LEFT JOIN PD_PRODUTOS AC ON AC.HANDLE = D.PRODUTO
INNER JOIN CM_UNIDADESMEDIDA EA ON (AC.UNIDADEMEDIDACOMPRAS = EA.HANDLE)
LEFT JOIN PD_FAMILIASPRODUTOS C ON C.HANDLE = D.FAMILIA
LEFT JOIN CT_CC RA ON RA.HANDLE = D.CENTROCUSTO

LEFT JOIN CP_SOLICITACOES SOLICITACAO ON SOLICITACAO.NUMERO = A.NUMERODOCUMENTOORIGEM
LEFT JOIN CP_REQUISICOES REQ ON REQ.ORDEMCOMPRA = A.HANDLE
LEFT JOIN CP_SOLICITACOES SOL ON SOL.NUMERO = REQ.NUMEROORIGEM
LEFT JOIN Z_GRUPOUSUARIOS CA ON A.USUARIOINCLUIU = CA.HANDLE
LEFT JOIN Z_GRUPOUSUARIOS B ON SOL.SOLICITANTE = B.HANDLE
LEFT JOIN Z_GRUPOUSUARIOS BB ON SOLICITACAO.SOLICITANTE = BB.HANDLE
LEFT JOIN Z_GRUPOUSUARIOS ZG on REQ.REQUISITANTE = ZG.HANDLE

LEFT JOIN Z_GRUPOUSUARIOS VA ON H.SOLICITANTE = VA.HANDLE
LEFT JOIN CP_CONDICOESPAGAMENTO CC ON CC.HANDLE = A.CONDICAOPAGAMENTO
LEFT JOIN CP_ORDENSCOMPRAENTREGA YY ON D.HANDLE = YY.ORDENSCOMPRAITENS
LEFT JOIN (SELECT CONDICOESPAGAMENTO,
avg(dias) as MEDIA_DIAS
from CP_MAPACONDICAOPAGAMENTO
GROUP BY CONDICOESPAGAMENTO) MCP ON CC.HANDLE = MCP.CONDICOESPAGAMENTO

WHERE A.STATUS IN ('2','3','4') AND YEAR(A.DATAINCLUSAO) >=2019
ORDER BY A.DATAINCLUSAO DESC
